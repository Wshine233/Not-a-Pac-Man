# Not a Pac-Man
A Python game for final assignment

## 游玩说明
开始界面按**Z**开始游戏（Z to start）
**方向键**控制移动方向（Arrow key to change move direction）

一次性游玩，三条命。（3 Lives）

## 用到的知识点
### 随机地图生成——WFC算法
Wave Function Collapse，先提前制作好地图块，然后用json文件来定义和设置地图块的邻接情况，以及生成的权重。
自己根据这个算法的图解按感觉写的，会概率性地遇到生成时间过长的情况，此时可以限定最大生成步数（尝试次数），超过步数则重新跑一遍算法。

### 处理封闭区域——BFS
从靠近中间的非墙体开始进行广度优先搜索，将所有路过的可通行地图块打上标记，之后角色、敌人、物品的生成都将在有标记的图块上进行。

### 入口点（传送点）设置——随机算法
地图上会随机生成1~3对传送点，首先选择可以通行的传送点，再放置传送门。
这里有两个很有意思的细节：
1. 地图中会有无法到达的地点，此时可能可以使用传送门到达。但这样对于可通行地图块的计算逻辑就会变得比较复杂，时间有限所以我没有对这种情况进行处理。而是**直接选取在可通行块内的入口点放置传送门**
2. 传送门的出入口之间最好要有一定的距离（你也不希望原地tp吧），也就是说，对于生成好的传送门，一对传送门之间的最短距离在所有放置传送门的情况中应该最大（最小值的最大值）。这也是我们要考虑的一点。
对于2中的问题，原本的方法我推测可能是二分图匹配，但我已经忘得差不多了，但最近用的随机算法正好可以在这里派上用场。
原理很简单，**随机生成8000个传送门方案，每个方案计算一个最小距离，从中找到最小距离最大的一个方案即可。**
错误概率极小，由于最多三对门，错误率14/15（其实会更小，因为一对一对的不需要考虑顺序，在这里只是为了好算），8000个全错的概率几乎为0.

### 敌人AI——随机游走
随机游走不需要详细介绍，我这里直接取字面意思，就是下一步的位置跟玩家的行动无关，完全随机。
不过为了让敌人看起来更自然，也需要进行一定的调整（减少左右横跳和在一个地方兜圈子的情况）
策略如下：
- 除非遇到死路，否则不会掉头后退
- 在决定下一步的方向时，更偏向于选择当前的运动方向（也就是更喜欢直走）
- 如果要转弯，则随机选择左右

### 敌人AI——A\*寻路
没实际上手写过A\*，就按照脑子里记忆的原理凭感觉写的。原理跟一般A\*一样我就不赘述了。
注意的是这个h_function，这个启发函数的内容决定了AI的移动偏好，为了让ai少走Z字，略微修改了一下函数内容，具体见代码。
由于这里的寻路是动态的，所以如果在每一个tick时都使用A\*算法寻找下一次该走哪一格，就会出现一个概率性的bug——**面对两条相同长度的道路时，ai会左右横跳**。
不过这里不影响什么，因为玩家终归是要走到别处去吃豆子的，所以这个bug不会很明显。

### 网格坐标系统
充分利用游戏更新方式的特殊性，每个游戏对象内都存有网格坐标，然后再在主更新函数中根据对象的网格坐标转换为实际的屏幕坐标。
*每帧更新的好处*

### 视觉与数据分离
由于使用了网格坐标系统，玩家的移动和地图块的寻址均不依赖游戏对象本身的位置，所以就算任意修改地图块的屏幕位置，游戏也能正常进行（只是看上去不知道哪里能走）。
简单来说可以想象成，贴图模型跑了，碰撞体还留在原地。

## Arcade的功能特性
### View视图
实现单窗口加载多个场景，跟Unity中的场景类似

### SpriteList
将同一类的Sprite放到SpriteList中统一渲染可以降低消耗（纯粹的DrawCall）

### 绘图时的filter
由于是复古风格，所以在缩放时应尽量保持整数缩放，且filter需要变成gl.NEAREST才不会因为取均值卷积之类的原因导致图变模糊。
有趣的是，变模糊的原因是为了抗锯齿（防走样），但复古像素恰恰不要抗锯齿。

### 动态加载材质、音乐、字体
load_xxx即可

### 可继承的窗体、视图、Sprite
这个是整个arcade的核心所在，所有的系统都是在继承之上进行的编写。继承基本的窗体之后，就可以写窗体的相关功能。这跟Unity的脚本组件模式有着较大的差别，不能说好或者不好，只是二者从语言上说就有各自的偏向性。

### UI系统
我实在不想说这个，用着太难受了，所以基本没做界面。
说得好听一点，就是充分利用现有资源设计效果，做到无UI引导。
貌似大部分游戏引擎做起UI来都不怎么好用。

Credit拿张图片从下往上移动就挺好，Word排版，PS合成，低成本快速制作。

## 其它想说的
希望以后能用正经开发游戏的平台和语言去做游戏，Python还是不适合游戏，做做数据分析就很舒服。

提示：`Ctrl+W`可以快速过关，制作者名单里的曲目为FamiTracker中自带的乐曲示例
